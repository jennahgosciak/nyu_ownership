---
title: "Exploratory analysis"
author: "Jennah Gosciak"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
knit: (function(inputFile, encoding) { 
  rmarkdown::render(inputFile,
  encoding=encoding,
  output_file="01_analysis.html")})
output:
  html_document:
    toc: true
    theme: paper
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, message = F, warning = F,
  fig.width = 6, fig.height = 10
)
```

```{r, setup2, include = F}
# Setup
library(renv)
library(tidyverse)
library(janitor)
library(magrittr)
library(eeptools)
library(assertr)
library(readr)
library(openxlsx)
library(DBI)
library(dplyr)
library(dbplyr)
library(RPostgres)
library(lubridate)
library(fs)
library(sf)
library(vroom)
library(leaflet)
library(haven)
library(geojsonsf)
library(s2)

source("99_common.R")
out <- "03_Output"
inp <- "01_Input"
fig_path <- path("03_Output", "figs")
web_path <- path("04_WebMap", "data")
spatial_path <- path("03_Output", "spatial_files")
colors <- c("#512e92","#e03616","#758ecd", "#FFC857","#0b5351")
```

# Analysis: 1998-2021

## Load cpi conversion factors
```{r, exp pluto}
# load cpi from bls
# method from: https://qrc.depaul.edu/oelguntillman/Winter12/Notes/7%20-%20CPI%20Notes.htm
cpi <- readxl::read_xlsx(path(inp, "r-cpi-u-rs-allitems.xlsx"),
                         skip = 5)
cpi

cpi_2020 <- cpi %>% 
  filter(YEAR == 2020) %>% 
  pull(AVG)

conversion_factors <- cpi %>% 
  filter(YEAR != 1977) %>% 
  mutate(conv = cpi_2020/AVG) %>% 
  rename(year = YEAR) %>% 
  select(year, conv)

conversion_factors
```


## NYU Assess Value Analysis
```{r}
drop_vars <- c("shape_area",
               "strgearea",
               "garagearea",
               "retailarea",
               "areasource",
               "otherarea",
               "landmark",
               "healtharea",
               "officearea",
               "ind_area",
               "comarea",
               "landmkdate",
               "factryarea",
               "areasource")

nyu_pts <- st_read(path(out, "nyu_allyrs_pts.geojson")) %>% 
  select(-any_of(drop_vars))%>%
  mutate(cd = ifelse(is.na(cd), cd2, cd),
         ownername = ifelse(is.na(ownername), str_trim(owner), str_trim(ownername))) %>% 
  mutate(borough = str_sub(cd, 1, 1)) %>% 
  select(-"cd2") %>% 
  verify(!is.na(borough)) %>% 
  filter(!(ownername %in% c("YOON, SOOK NYU", "YOON, SUK NYU", "ARA HOLDINGS OF NYU L",
                            "ARA HOLDINGS OF NYU LLC")))

nyu_poly <- st_read(path(out, "nyu_allyrs.geojson")) %>% 
  select(-any_of(drop_vars))%>%
  mutate(cd = ifelse(is.na(cd), cd2, cd),
         ownername = ifelse(is.na(ownername), str_trim(owner), str_trim(ownername))) %>% 
  mutate(borough = str_sub(cd, 1, 1)) %>% 
  select(-"cd2") %>% 
  verify(!is.na(borough)) %>% 
  filter(!(ownername %in% c("YOON, SOOK NYU", "YOON, SUK NYU", "ARA HOLDINGS OF NYU L",
                            "ARA HOLDINGS OF NYU LLC")))

nyu_21 <- st_read(path(out, "nyu_21.geojson")) %>% 
  filter(!(ownername %in% c("YOON, SOOK NYU", "YOON, SUK NYU", "ARA HOLDINGS OF NYU L",
                            "ARA HOLDINGS OF NYU LLC")))

nyu_poly %>% 
  st_transform(4326) %>% 
  st_write(dsn = path(web_path, "nyu_allyrs.geojson"),
           delete_dsn = T,
           append = F)

nyu_pts %>% 
  st_transform(4326) %>% 
  st_write(dsn = path(web_path, "nyu_allyrs_pts.geojson"),
           delete_dsn = T,
           append = F)
```

```{r}
url_boro <- "https://services5.arcgis.com/GfwWNkhOj9bNBqoJ/arcgis/rest/services/NYC_Borough_Boundary/FeatureServer/0/query?where=1=1&outFields=*&outSR=4326&f=pgeojson"
url_nhood <- "https://services5.arcgis.com/GfwWNkhOj9bNBqoJ/arcgis/rest/services/NYC_Neighborhood_Tabulation_Areas_2020/FeatureServer/0/query?where=1=1&outFields=*&outSR=4326&f=pgeojson"
url_streets <- "https://data.cityofnewyork.us/resource/m6hn-ddkx.geojson?$limit=200000"
url_roads <- "https://data.cityofnewyork.us/resource/gdww-crzy.geojson"
url_cds <- "https://data.cityofnewyork.us/resource/jp9i-3b7y.geojson?$limit=200000"
url_parks <- "https://data.cityofnewyork.us/resource/y6ja-fw4f.geojson?$limit=200000"

# load boros
boro <- st_read(url_boro) %>% 
  st_transform(2263)

# load major streets
# streets <- st_read(url_streets) %>% 
#   st_transform(2263)
# nrow(streets)

# load cds
cds <- st_read(url_cds)  %>% 
  st_transform(2263)

# load parks
parks <- st_read(url_parks) %>% 
  st_transform(2263)

# load nhood
nhood <- st_read(url_nhood)  %>% 
  st_transform(2263)

nyu_poly
```
## NYU in 2021
```{r}
# Identify list of community districts
intersecting_cds <- nyu_pts %>% 
  st_join(cds, join = st_intersects) %>% 
  filter(!is.na(boro_cd)) %>% 
  pull(boro_cd) %>% 
  unique()

# checking geometry works
# example of plot
nyu_poly %>% 
  filter(year == 2021) %>% 
  ggplot() +
  geom_sf(data = boro, color = "gray", fill = NA) +
  geom_sf(data = cds, color = "black", fill = NA, alpha = 0.5) +
  geom_sf(data = streets %>% 
            st_crop(ext) %>% 
            select(c("post_type")), color = "gray", size = 1, fill = NA) +
  geom_sf(fill = colors[1], color = NA) +
  coord_sf(xlim = c(ext[1], ext[3]),ylim = c(ext[2], ext[4]),
           expand = F) +
  theme_void()

nyu_poly %>% 
  filter(year == 2021) %>% 
  as_tibble() %>% 
  pull(cd) %>% 
  unique()

nyu_poly %>% 
  filter(year == 2021) %>% 
  as_tibble() %>% 
  arrange(cd) %>% 
  select(c("cd", "bbl", "ownername", "address"), everything()) %>% 
  verify(!is.na(bldgarea))

nyu_poly %>% 
  filter(year == 2021) %>% 
  as_tibble() %>% 
  arrange(cd) %>% 
  select(c("cd", "bbl", "ownername", "address"), everything()) %>% 
  verify(!is.na(bldgarea)) %>% 
  group_by(cd) %>% 
  summarize(total_bldarea = sum(bldgarea),
            total_bld = n_distinct(bbl))

nyu_poly %>% 
  filter(year == 2021) %>% 
  as_tibble() %>% 
  arrange(cd) %>% 
  select(c("cd", "bbl", "ownername", "address"), everything()) %>% 
  verify(!is.na(bldgarea)) %>% 
  filter(address == "28 BETHUNE STREET" |
         address == "63 CHARLES STREET")

nyu_poly %>% 
  filter(year == 2021) %>% 
  as_tibble() %>% 
  arrange(cd) %>% 
  select(c("cd", "bbl", "ownername", "address"), everything()) %>% 
  verify(!is.na(bldgarea)) %>% 
  filter(cd == 307)
# 
# total_lotarea <- tbl(con, "mappluto_21v3") %>% 
#   filter(bldgclass %in% c("W5", "W6")) %>% 
#   summarize(total_lotarea = sum(lotarea, na.rm = T),
#             total_bldgarea = sum(bldgarea, na.rm = T)) %>% 
#   as_tibble()
# total_lotarea

nyu_21 %>% 
  as_tibble() %>% 
  summarize(nyu_lotarea = sum(lotarea, na.rm = T),
            nyu_bldgarea = sum(bldgarea, na.rm = T))
  
# nyu_21 %>% 
#   filter(bldgclass %in% c("W5", "W6")) %>% 
#   as_tibble() %>% 
#   summarize(nyu_lotarea = sum(lotarea, na.rm = T),
#             nyu_bldgarea = sum(bldgarea, na.rm = T)) %>% 
#   cbind(total_lotarea) %>% 
#   mutate(nyu_lotshare = nyu_lotarea * 100 / total_lotarea,
#          nyu_bldgshare = nyu_bldgarea * 100 / total_bldgarea)

nyu_21 %>% 
  filter(landuse %in% c("01", "02", "03", "04")) %>% 
  as_tibble() %>% 
  summarize(nyu_lotarea = sum(lotarea, na.rm = T),
            nyu_bldgarea = sum(bldgarea, na.rm = T))

nyu_21 %>% 
  filter(str_sub(bldgclass, 1, 1) == "I") %>% 
  as_tibble() %>% 
  summarize(nyu_lotarea = sum(lotarea, na.rm = T),
            nyu_bldgarea = sum(bldgarea, na.rm = T))

nyu_21 %>% 
  filter(bldgclass %in% c("W5", "W6")) %>% 
  as_tibble() %>% 
  pull(landuse) %>% 
  unique()

nyu_21 %>%
  summarize(assesstot = sum(assesstot, na.rm = T))
```

# Interactive map in leaflet
```{r}
nyu_leaflet <- st_transform(nyu_poly, 4263) %>% 
  filter(year == 2021) %>% 
  filter(!st_is_empty(.))

map_interactive <- leaflet(nyu_leaflet) %>%
  setView(lng = -73.9973, 
          lat = 40.7309, zoom = 14) %>% 
  addProviderTiles(provider = "CartoDB.DarkMatterNoLabels") %>% 
  addPolygons(color= "#9057FF", stroke = F,
              label = ~address, fillOpacity = 1)
map_interactive
```

```{r}
# function to clip and export by cd in 2021
# programmatically exporting plots
expt_cd <- function(cds, shp, cd_num, yr) {
  cd_clip <- cds %>% 
    filter(boro_cd == cd_num)
  
  ext <- cd_clip %>% 
    st_bbox()
  
    
  cd_clip %>% 
    st_write(dsn = path(spatial_path, paste0("cd_", cd_num, ".geojson")),
             delete_dsn = T,
             append = F)
  
  shp %>% 
    filter(year == yr) %>% 
    st_join(cd_clip, join = st_intersects) %>%
    st_write(dsn = path(spatial_path, paste0("nyu_cd_", cd_num, "_", yr, ".geojson")),
             delete_dsn = T,
             append = F)
  
  # create an export plot
  nyu_poly %>% 
    filter(year == yr) %>% 
    ggplot() +
    geom_sf(data = streets %>% 
              st_crop(ext) %>% 
            select(c("post_type")), 
    color = "white", size = 0.5, fill = NA) +
    geom_sf(data = parks,
            fill = "#777777", color = NA) +
    geom_sf(fill = "#9057FF", color = NA) +
    geom_sf(data = cds, color = "blue", fill = NA, size = 3) +
    coord_sf(xlim = c(ext[1], ext[3]), ylim = c(ext[2], ext[4]),
             expand = F) +
    theme_void() +
    theme(plot.background = element_rect(fill = '#424242'))
    
  ggsave(path(fig_path, paste0("nyu_cd_", cd_num, "_", yr, ".pdf")))
}

# output all cds with nyu property in 2021
# walk(intersecting_cds, ~expt_cd(cds, nyu_poly, ., 2021))
```
```{r}
# nyu_21 %>% 
#   ggplot() +
#   geom_sf(data = streets,
#           color = "white", size = 0.01, alpha = 0.2, fill = NA) +
#   geom_sf(data = parks,
#             fill = "#777777", color = NA) +
#   geom_sf(fill = "#9057FF", color = NA) +
#   geom_sf(data = cds, color = "#777777", fill = NA, size = 0.1) +
#   theme_void() +
#   theme(
#     panel.border = element_blank(),
#     axis.text = element_blank(),
#     panel.grid = element_blank(),
#     axis.ticks = element_blank(),
#     plot.background = element_rect(fill = '#A5A5A5', color = NA),
#     panel.background = element_rect(fill = '#A5A5A5', color = NA)
#   )
# 
# ggsave(path(fig_path, "nyu_21_map.pdf"), height = 12.5, width = 24)
# #ggsave(path(fig_path, "nyu_21_map.png"), height = 12.5, width = 20)
```


```{r}
# create a dataframe of the properties
nyu_df <- nyu_poly %>% 
  select(-any_of(drop_vars)) %>% 
  mutate(geom_point = geometry)

nyu_df

nyu_df %>% 
  filter(year == 1999)

nyu_df %>% 
  filter(bbl == "1009364222") %>% 
  as_tibble() %>% 
  select(c("year"), everything())
```
```{r}
# number of buildings by year
nyu_df %>% 
  group_by(year) %>% 
  summarize(count = n_distinct(bbl)) %>% 
  ggplot() +
  geom_line(aes(year, count)) +
  scale_x_continuous(limits = c(1998, 2021),
                     breaks = seq(1998, 2021, 3)) +
  theme_classic() +
  labs(x = "Year",
       y = "Number of buildings")

nyu_df %>% 
  filter(year == 2001) %>% 
  tablist_qc(ownername)
```

```{r}
# Class 4: All commercial and industrial properties, such as office, retail, factory buildings and all other properties not 
# included in tax classes 1, 2 or 3.

## Load tax rate
tax_rate <- read_csv(path(inp, "Property_Tax_Rates_by_Tax_Class.csv")) %>% 
  select(c("YEAR", "CLASS 4")) %>% 
  rename(year = YEAR) %>% 
  filter(!is.na(year)) %>% 
  mutate(rate = as.numeric(str_replace_all(`CLASS 4`, "%", ""))/100)
tax_rate
```


```{r, warning = F}
# load assessed_value_avg
assessed_value_avg <- readRDS(path(out, "assess_value_averages.RDS"))

nrow(nyu_df)

nyu_assess_value <- nyu_df %>%
  mutate(borough = str_sub(cd, 1, 1),
           cd = as.numeric(cd)) %>% 
  left_join(conversion_factors, by = "year") %>% 
  left_join(assessed_value_avg, by = c("cd", "year")) %>% 
  left_join(tax_rate, by = "year") %>% 
  rowwise() %>%
  mutate(assessed_value_orig = max(assesstotl, 
                                   assesstota, 
                                   assesstot, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(taxes_calc = rate * assessed_value_orig) %>% 
  group_by(year) %>% 
  mutate(taxes_yr = sum(taxes_calc, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(bldgarea = case_when(is.na(bldgarea) | bldgarea == 0 ~ floorarea,
                              TRUE ~ as.double(bldgarea))) %>%
  mutate(assessed_value = if_else(is.na(bldgarea) | bldgarea == 0, 
                                  lotarea * avg_value_sqft,
                                  bldgarea * avg_value_sqft)) %>% 
  mutate(borough = recode(borough, "3" = "Brooklyn", "1" = "Manhattan",
                          "2" = "Bronx", "5" = "Staten Island",
                          "4" = "Queens")) %>% 
  mutate(assessed_adj = if_else(year < 2021,
                                round(assessed_value * conv),
                                assessed_value),
         assessed_adj_orig = if_else(year < 2021,
                                round(assessed_value_orig * conv),
                                assessed_value_orig),
         taxes_calc = if_else(year < 2021,
                              round(taxes_calc * conv),
                              taxes_calc),
         taxes_yr = if_else(year < 2021,
                            round(taxes_yr * conv),
                            taxes_yr))

nyu_assess_geo <- nyu_assess_value  %>% 
  st_transform(4326) %>%
  mutate(bldgarea = case_when(is.na(bldgarea) ~ floorarea,
                              TRUE ~ bldgarea)) %>% 
  select(
    "ownername", "year", "assessed_adj",
    "assessed_adj_orig",
    matches("area"),
    "cd",
    "address", "bbl", "borough",
    "taxes_yr", "taxes_calc", 
    matches("area")) %>% 
  mutate(across(c("assessed_adj",
                "assessed_adj_orig",
                "taxes_yr",
                "taxes_calc",
                "bldgarea"), ~if_else(is.na(.) | is.infinite(.), "", prettyNum(., big.mark = ",")))) %>% 
  mutate(across(c("address",
                "ownername"), ~if_else(is.na(.) | is.infinite(.), "", .))) %>% 
  mutate(across(c("assessed_adj",
                "assessed_adj_orig",
                "taxes_yr",
                "taxes_calc"), ~if_else(. != "", str_c("$",.), "")))

nyu_assess_geo %>% 
  filter(year == 1997)
 
fix_geom <- nyu_assess_geo %>% 
  filter(st_is_empty(geometry)) %>% 
  as_tibble() %>% 
  select(-"geometry") %>% 
  left_join(mutate(nyu_assess_geo, year = year - 1) %>% 
              select(c("year", "geometry")) %>% 
              bind_rows(mutate(nyu_assess_geo, year = year - 3) %>% 
              select(c("year", "geometry"))), by = "year", suffix = c("orig", "new"))
  
nyu_assess_geo %>% 
  filter(st_is_empty(geometry)) %>% 
  nrow() 

fix_geom <- fix_geom %>% 
    filter(!st_is_empty(geometry)) %>% 
    group_by(bbl, year) %>% 
    filter(row_number() == 1) %>%
    st_as_sf()
fix_geom


nyu_assess_geo %>% 
  filter(st_is_empty(geometry)) %>% 
  bind_rows(fix_geom) %>% 
  st_write(
    dsn = path(
      "04_WebMap",
      "data",
      "nyu_clean.geojson"
    ), driver = "GeoJSON",
    append = F,
    delete_dsn = T
  )
```
## Assessed value over time
```{r}
# assess value over time
nyu_assess_value %>% 
  group_by(borough, year) %>%
  summarize(avg_assessed_value = mean(assessed_value, na.rm = T)/1000) %>% 
  ggplot() +
  geom_line(aes(year, avg_assessed_value, color = borough)) +
  #scale_y_continuous(limits = c(0, 2000)) +
  theme_classic() +
  labs(x = "Year",
       y = "Average assessed value in thousands") +
  scale_color_manual(values = colors,
                     name = "Borough")

ggsave(path(fig_path, "assess_value1.png"))

nyu_assess_value %>% 
  group_by(borough, year) %>%
  filter(borough != "MN") %>% 
  summarize(avg_assessed_value = mean(assessed_value, na.rm = T)/1000) %>% 
  ggplot() +
  geom_line(aes(year, avg_assessed_value, color = borough)) +
  theme_classic() +
  labs(x = "Year",
       y = "Average assessed value in thousands") +
  scale_color_manual(values = colors,
                     name = "Borough")
ggsave(path(fig_path, "assess_value2.png"))

nyu_assess_value %>% 
  group_by(borough, year) %>%
  summarize(avg_assessed_value = mean(assessed_value_orig, na.rm = T)/1000) %>% 
  ggplot() +
  geom_line(aes(year, avg_assessed_value, color = borough)) +
  theme_classic() +
  labs(x = "Year",
       y = "Average assessed value in thousands") +
  scale_color_manual(values = colors,
                     name = "Borough")

ggsave(path(fig_path, "assess_value2.png"))
```
## Analysis of square footage (building or floor square footage)
```{r}
nyu_area <- nyu_pluto_app %>% 
  mutate(bldgarea = if_else(is.na(bldgarea), floorarea, as.double(bldgarea))) %>% 
  as_tibble() %>% 
  verify(!is.na(bldgarea)) %>% 
  group_by(borough, cd, year) %>%
  summarize(bldgarea_total = sum(bldgarea, na.rm = T)) %>% 
  group_by(borough, year) %>%
  mutate(bldgarea_total_boro = sum(bldgarea_total, na.rm = T)) %>% 
  rowwise() %>%
  mutate(bldgarea_share = round(bldgarea_total * 100 / bldgarea_total_boro)) %>% 
  ungroup() %>% 
  mutate(across(c("bldgarea_total", "bldgarea_total_boro"), ~./1000)) %>% 
  mutate(borough = recode(borough, "BK" = "Brooklyn", "MN" = "Manhattan",
                          "BX" = "Bronx", "SI" = "Staten Island",
                          "QN" = "Queens"))

nyu_area %>% 
  select(c("borough", "year", "bldgarea_total_boro")) %>% 
  unique() %>% 
  ggplot() +
  geom_line(aes(year, bldgarea_total_boro, color = borough)) +
  theme_classic() +
  labs(x = "Year",
       y = "Square feet in thousands") +
  scale_color_manual(values = colors)
ggsave(path(fig_path, "area_1.pdf"))

nyu_area %>% 
  filter(borough == "Manhattan" | borough == "Brooklyn") %>% 
  select(c("borough", "year", "bldgarea_total_boro")) %>% 
  unique() %>% 
  ggplot() +
  geom_line(aes(year, bldgarea_total_boro, color = borough)) +
  theme_classic() +
  labs(x = "Year",
       y = "Square feet in thousands") +
  scale_color_manual(values = colors)
ggsave(path(fig_path, "area_2.pdf"))
```

```{r}
# investigating dip in square footage
nyu_pluto_app %>% 
  filter(year == 2012) %>% 
  as_tibble() %>% 
  anti_join(nyu_pluto_app %>%
              filter(year == 2015) %>% 
              as_tibble(), by = "bbl") %>% 
  select(c("bbl"), everything())

tbl(con, "mappluto_12v2") %>% 
  filter(bbl == "1005400024") %>% 
  select(c("ownername"), everything())

tbl(con, "mappluto_15v1") %>% 
  filter(bbl == "1005400024") %>% 
  select(c("ownername", "bldgarea"), everything())
```


# Load deed data from Acris
```{r}
tbl(con, "acris_document_control_codes") %>% 
  filter(class_code_description == 'DEEDS AND OTHER CONVEYANCES')

## Load acris data, deed records
nyu_acris <- dbGetQuery(con, paste0("SELECT p.*, m.*, l.property_type,
                  l.street_number, l.street_name, l.aptno, l.bbl FROM acris_parties as p
                  INNER JOIN acris_master as m on (p.document_id = m.document_id)
                  LEFT JOIN acris_document_control_codes as d on (m.doc_type = d.doc_type)
                  LEFT JOIN acris_legals as l on (p.document_id = l.document_id)
                  WHERE p.name ~* '^(NYU)$|(\\sNYU,?\\s)|(NEW YORK UNIV.+)|^(NYU,?\\s)'
                  AND p.name NOT IN ('NYU, SOON KEAT',
                                  'OK NYU PARK, AS ADMINISTRATOR OF ESTATE',
                                  'YOON, SOOK NYU CHUNG')"))
nyu_acris

nyu_acris %>%
  tablist_qc(name)

nyu_acris_filt <- nyu_acris %>%
  filter(doc_type != "EASE") %>% 
  arrange(desc(doc_date)) %>% 
  select(c("doc_date","bbl"), everything()) %>% 
  mutate(apt = case_when(!is.na(aptno) ~ 1,
                         TRUE ~ 0))

nyu_acris_filt %>% 
  mutate(doc_type = str_trim(doc_type)) %>% 
  select(c("doc_type", "document_id")) %>% 
  unique() %>% 
  group_by(doc_type) %>% 
  summarize(count = n()) %>% 
  filter(count > 0) %>% 
  arrange(-count)
```

Number of documents over time
```{r}
nyu_acris_filt %>% 
  filter(!is.na(doc_date)) %>% 
  select(c("document_id", "doc_date")) %>% 
  unique() %>% 
  group_by(doc_date) %>% 
  mutate(count = n()) %>% 
  arrange(-count)

nyu_acris_filt %>% 
  select(c("document_id", "doc_date")) %>% 
  unique() %>% 
  group_by(doc_date) %>% 
  mutate(count = n()) %>% 
  ggplot() +
  geom_line(aes(doc_date, count)) +
  theme_classic() +
  scale_y_continuous(limits = c(0,40)) +
  scale_x_date(date_labels = "%Y",
               date_breaks = "10 years",
               limit = c(as.Date("1963-01-01"), as.Date("2021-01-01"))) +
  labs(y = "Number of documents",
       x = "Date")

nyu_acris_filt  %>% 
  select(c("document_id", "doc_date")) %>%
  unique() %>% 
  mutate(doc_year = as.numeric(format(doc_date, "%Y"))) %>% 
  group_by(doc_year) %>% 
  summarize(count = n()) %>% 
  ggplot() +
  geom_line(aes(doc_year, count)) +
  theme_classic() +
  scale_y_continuous(limits = c(0,600)) +
  scale_x_continuous(limits = c(1960, 2021),
                  breaks = seq(1960, 2021, 10)) +
  labs(y = "Number of documents",
       x = "Year")

nyu_acris_filt  %>% 
  select(c("document_id", "doc_date", "doc_type")) %>%
  unique() %>% 
  mutate(doc_year = as.numeric(format(doc_date, "%Y"))) %>% 
  group_by(doc_year, doc_type) %>% 
  summarize(count = n()) %>% 
  ggplot() +
  geom_line(aes(doc_year, count, fill = doc_type)) +
  theme_classic() +
  scale_y_continuous(limits = c(0,600)) +
  scale_x_continuous(limits = c(1960, 2021),
                  breaks = seq(1960, 2021, 10)) +
  labs(y = "Number of documents",
       x = "Year")
```
```{r}
copy_to(con, nyu_acris_filt,
  name = "nyu_acris_filt", overwrite = T,
  temporary = T
)

nyu_acris_pluto <- tbl(con, "nyu_acris_filt") %>% 
  left_join(tbl(con, "mappluto_21v3"), by = "bbl") %>% 
  as_tibble()

nyu_acris_clean <- nyu_acris_pluto %>% 
  mutate(nyu_role = case_when(party_type == 2 ~ "Buyer",
                              party_type == 1 ~ "Seller",
                              TRUE ~ NA_character_))  %>% 
  mutate(appdate = mdy(appdate)) %>% 
  rowwise() %>% 
  mutate(max_date = max(doc_date, assessment_date, modified_date,
                        appdate, na.rm = T),
         min_date = min(doc_date, assessment_date, 
                        modified_date, appdate,
                        na.rm = T)) %>% 
  select(c("document_id", "bbl", "street_number", "street_name", "city", "zip",
           "nyu_role", "doc_date", "doc_type", "min_date", "max_date",
           "name", "address"))

nyu_acris_clean %>% 
  filter(document_id == "FT_1650000478165")

tbl(con, "acris_legals") %>% 
  filter(bbl == "1000510015") %>% 
  inner_join(tbl(con, "acris_parties"), by = "document_id") %>% 
  inner_join(tbl(con, "acris_master"), by = "document_id") %>% 
  filter(modified_date < as.Date("1990-01-01")) %>% 
  select(c("doc_type"), everything()) %>% 
```


## Geocode deed records
```{r}
library(geoclient)
geoclient_api_key(key = "8023630502244bbbb65e9090d28c2615", overwrite = T, install = T)



geocode <- nyu_acris %>% 
  mutate(address_form = str_c(paste(street_number, street_name), 
                              city, state, zip, sep = ", ")) %>% 
  geo_search_data(address_form)
geocode
```

